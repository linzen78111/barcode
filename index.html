<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¢ç¢¼ç³»çµ±</title>
    <!-- PWA åˆå§‹åŒ–æª¢æ¸¬ï¼Œå¿…é ˆæœ€å…ˆåŠ è¼‰ -->
    <script src="js/pwa-init.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <!-- PWA ç›¸é—œ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4285F4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¢ç¢¼ç³»çµ±">
    <link rel="apple-touch-icon" href="assets/icon-192x192.png">
    <!-- iOS å•Ÿå‹•ç•«é¢ -->
    <link rel="apple-touch-startup-image" href="assets/icon-512x512.png">
    <!-- å„ç¨® iOS å•Ÿå‹•ç•«é¢å°ºå¯¸ -->
    <link rel="apple-touch-startup-image" href="assets/icon-512x512.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="assets/icon-512x512.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="assets/icon-512x512.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="assets/icon-512x512.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="assets/icon-512x512.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="assets/icon-512x512.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    <!-- Favicon -->
    <link rel="icon" href="assets/icon-192x192.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* åŸºæœ¬æ¨£å¼ */
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f9f9f9;
            overflow: hidden;
        }
        
        /* ç™»å…¥æŒ‰éˆ•é»æ“Šæ•ˆæœ */
        .btn-google {
            transition: all 0.3s;
        }
        
        .btn-google:active, .btn-google.button-clicked {
            background-color: #e0e0e0 !important;
            transform: scale(0.95);
        }
        
        /* ç¢ºä¿ç™»å…¥æŒ‰éˆ•åœ¨ PWA æ¨¡å¼ä¸‹æ›´å®¹æ˜“é»æ“Š */
        @media (display-mode: standalone), (display-mode: fullscreen) {
            .btn-google {
                padding: 16px !important;
                margin: 20px auto !important;
                min-height: 50px !important;
                cursor: pointer !important;
                -webkit-tap-highlight-color: rgba(0,0,0,0.2) !important;
            }
        }
    </style>
</head>
<body>
    <!-- æ·»åŠ èª¿è©¦å€åŸŸ -->
    <div id="debug-panel" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; font-size: 10px; max-height: 150px; overflow-y: auto; z-index: 10000; padding: 5px;">
        <div>èª¿è©¦é¢æ¿</div>
        <div id="debug-log"></div>
    </div>

    <!-- PWA ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="pwa-status" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: rgba(66, 133, 244, 0.8); color: white; font-size: 12px; padding: 4px 8px; z-index: 9999; text-align: center;">PWA æ¨¡å¼</div>

    <!-- é–‹ç™¼è€…å…¬å‘Š -->
    <div class="announcement-overlay" id="announcementOverlay"></div>
    <div id="developerAnnouncement" class="announcement-modal">
        <div class="announcement-content">
            <div class="announcement-header">
                <h2>é–‹ç™¼è€…å…¬å‘Š</h2>
            </div>
            <div id="announcementContent" class="announcement-text">
                <!-- å…¬å‘Šå…§å®¹å°‡å‹•æ…‹æ’å…¥ -->
            </div>
            <div class="announcement-actions">
                <label class="dont-show-today">
                    <input type="checkbox" id="dontShowToday">
                    <span>ä»Šå¤©ä¸å†é¡¯ç¤º</span>
                </label>
                <button id="closeAnnouncement" class="btn-close">
                    <span class="save-text">å„²å­˜ä¸¦é—œé–‰</span>
                    <span class="close-text">é—œé–‰</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ¼¢å ¡é¸å–®æŒ‰éˆ• -->
    <button class="menu-toggle" id="menuToggle">â˜°</button>

    <div class="layout">
        <div id="app">
            <!-- ç™»å…¥é é¢ -->
            <div id="loginPage" class="page">
                <div class="login-container">
                    <h1>æ­¡è¿ä½¿ç”¨</h1>
                    <button id="googleLoginBtn" class="btn-google">
                        <img src="assets/google-icon.svg" alt="Google Logo">
                        ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                    </button>
                </div>
            </div>

            <!-- ä¸»é é¢ -->
            <div id="mainPage" class="page hidden">
                <!-- é®ç½©å±¤ -->
                <div class="overlay"></div>
                <!-- å´é‚Šæ¬„ -->
                <aside class="sidebar">
                    <div class="user-info">
                        <img id="userAvatar" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAABmJLR0QA/wD/AP+gvaeTAAAFWUlEQVR4nO2dW2gdRRjHf01qYhvT1jQ1llgVRaUqKGqLF7wgVkGsICjeBW96Qa0PXkAFwQcFQfBJEcUH9UXFNxVURBCl2IogqFRNa2ubxjQ2sfWSNI1tzPHhOyGbs2fP2Z2Z3T27+/3gkOzZ+Wbmn29nZ+abmTOQSCQSiUQikUgkEolEIpFIJBL5kAEuBQaD1yRxCrgN6AzejEQVHcBzwAywGLwmGQN2AGuCNyVRxRpgJ/A/lcKYBu4DVgVvUWKBVcD9wAxLhTED7ENGTiIiHMAIY4FKYUwDB0mTv6g4gBHGApXC+BG4JXiLEhVsBg5QLYxp4EWgO3iLElV0Ay9QLYxTwF6gK3iLElV0AXuQyb1aGO8C64O3KFHF+ZiRMUulME4CzwJrg7coUcU64DmqhTENvAVsCN6iRBXnAa8ho6FaGO8D5wRvUaKKjcDrVAtjGvgHuCJ4ixJVXA68R7UwpoHXgY3BW5SoYhPwJtXCmAaOAlcGb1Giiq3AEaqFMQ0cAq4K3qJEFdcAH1EtjGngMHBt8BYlqrgOOEa1MKaBT4Drg7coUcX1wKdUC2MaOAHcGLxFiSpuAj6nWhjTwL/AzcFblKhiO/Al1cKYBk4CdwRvUaKK24GvqBbGNPAVcGfwFiWquAv4hmphTAPfAXcHb1Giiu3A91QLYxr4AbgneIsSVdwL/Ei1MKaBn4D7grcoUcX9wM9UC2MaGAUeCN6iRBUPAmNUC2MaOA48FLxFiSp2AL9SLYxp4DfgkeAtSlTxKPA71cKYBv4EHg/eokQVTwB/US2MaeAv4MngLUpU8RTwLvaimALeRTakJiLwCPAe9qKYAt4Bbg3eokQVjwHvYy+KSeBt4LbgLUpUsRN7UUwCbwG3B29RooongA+xF8UE8CZwR/AWJarYhf0bzxPAG8CdwVuUqGI38An2ohgH9gN3BW9RooqngU+xF8U4MkruDt6iRBXPAJ9hL4px4HXSyUFReRb4HHtRjAGvAQ8Hb1Giit3AF9iL4l/gVdKJQVF5DvgSe1H8A7wCPBq8RYkq9gBfYS+Kv4GXgceCt8gjnchwtTkXtVlZi3x33kYUfyH7rB8P2hpPOpEZ/3HkqZ5EhvtxZLjPIvv5diB7/TaRf5/1KmSF9XLgQuQjk5cBlwCXIn+7kMsF+5AzX9YHqL8uepA7eRw5xHcM+QjkGHLAzgRyZ08hzx/1jAFvBK9JIpFIJBKJRCKRSCQSiUQikUgkEolEIpFIJBKJRCKRSCQSiUQikUgkEolEIpFIJBKJRCKRSCQSiUQikcif/wFQaV3gXOJIjQAAAABJRU5ErkJggg==" alt="ä½¿ç”¨è€…é ­åƒ">
                        <span id="userName">ä½¿ç”¨è€…åç¨±</span>
                    </div>
                    <nav class="nav-menu">
                        <button class="nav-item active" data-page="official">
                            <i class="fas fa-database"></i>
                            å®˜æ–¹è³‡æ–™ï¼ˆè‡ªå‹•åŒæ­¥ï¼‰
                        </button>
                        <button class="nav-item" data-page="personal">
                            <i class="fas fa-user"></i>
                            å€‹äººè³‡æ–™ï¼ˆç”¨æˆ¶æ–°å¢ï¼‰
                        </button>
                        <button class="nav-item" data-page="scan">
                            <i class="fas fa-barcode"></i>
                            Scan(æœªé–‹ç™¼å®Œæˆ)
                        </button>
                        <button class="nav-item" data-page="manual">
                            <i class="fas fa-edit"></i>
                            æ‰‹è¼¸æ¢ç¢¼
                        </button>
                        <button id="uploadButton" class="nav-item" data-page="upload">
                            <i class="fas fa-upload"></i>
                            é€ä¿¡
                        </button>
                        <button id="showAnnouncementBtn" class="nav-item">
                            <i class="fas fa-bullhorn"></i>
                            å…¬å‘Š
                        </button>
                    </nav>
                    <button id="logoutBtn" class="btn-logout">
                        <span class="icon">ğŸšª</span>
                        ç™»å‡º
                    </button>
                </aside>

                <!-- ä¸»è¦å…§å®¹å€ -->
                <main class="main-content">
                    <div class="content-header">
                        <div class="search-container">
                            <input type="text" id="searchInput" placeholder="æœå°‹æ¢ç¢¼æˆ–å•†å“åç¨±...">
                            <select id="storeFilter">
                                <option value="711">7-11</option>
                                <option value="family">å…¨å®¶</option>
                                <option value="hilife">èŠçˆ¾å¯Œ</option>
                                <option value="ok">OKè¶…å•†</option>
                            </select>
                        </div>
                    </div>

                    <!-- è³‡æ–™åˆ—è¡¨ -->
                    <div id="barcodeList" class="barcode-list">
                        <!-- è³‡æ–™æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                    </div>
                </main>
            </div>

            <!-- æ‰‹å‹•è¼¸å…¥é é¢ -->
            <div id="manualPage" class="page hidden">
                <div class="manual-page">
                    <div class="manual-header">
                        <button class="btn-back">
                            <span class="icon">â†</span>
                            è¿”å›
                        </button>
                        <h2>æ‰‹å‹•è¼¸å…¥æ¢ç¢¼</h2>
                    </div>
                    <form class="barcode-form" id="manualForm">
                        <div class="form-group">
                            <label for="manualCode">æ¢ç¢¼</label>
                            <input type="text" id="manualCode" required>
                        </div>
                        <div class="form-group">
                            <label for="manualName">å•†å“åç¨±</label>
                            <input type="text" id="manualName" required>
                        </div>
                        <div class="form-group">
                            <label for="manualPrice">åƒ¹æ ¼</label>
                            <input type="number" id="manualPrice" required>
                        </div>
                        <div class="form-group">
                            <label for="manualStore">å•†åº—</label>
                            <select id="manualStore" required>
                                <option value="711">7-11</option>
                                <option value="family">å…¨å®¶</option>
                                <option value="hilife">èŠçˆ¾å¯Œ</option>
                                <option value="ok">OKè¶…å•†</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="manualDescription">æè¿°</label>
                            <textarea id="manualDescription"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">å„²å­˜</button>
                            <button type="button" class="btn-cancel">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- æƒæé é¢ -->
            <div id="scanPage" class="scan-page hidden">
                <div class="scan-container">
                    <div class="scan-header">
                        <button class="btn-back">
                            <span class="icon">â†</span>
                            è¿”å›
                        </button>
                        <h2>æƒææ¢ç¢¼</h2>
                    </div>
                    <div id="reader"></div>
                    <div id="scanResult" class="scan-result hidden">
                        <h3>æƒæçµæœ</h3>
                        <form id="barcodeForm" class="barcode-form">
                            <div class="form-group">
                                <label for="name">å•†å“åç¨±</label>
                                <input type="text" id="name" required>
                            </div>
                            <div class="form-group">
                                <label for="code">æ¢ç¢¼</label>
                                <input type="text" id="code" readonly>
                            </div>
                            <div class="form-group">
                                <label for="price">åƒ¹æ ¼</label>
                                <input type="number" id="price" required>
                            </div>
                            <div class="form-group">
                                <label for="store">å•†åº—</label>
                                <select id="store" required>
                                    <option value="711">7-11</option>
                                    <option value="family">å…¨å®¶</option>
                                    <option value="hilife">èŠçˆ¾å¯Œ</option>
                                    <option value="ok">OKè¶…å•†</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="description">æè¿°</label>
                                <textarea id="description"></textarea>
                            </div>
                            <div class="form-buttons">
                                <button type="submit" class="btn-save">å„²å­˜åˆ°æœ¬åœ°</button>
                                <button type="button" class="btn-cancel">å–æ¶ˆ</button>
                                <button type="button" class="btn-rescan">é‡æ–°æƒæ</button>
                            </div>
                        </form>
                    </div>
                    <!-- æ–°å¢ï¼šæš«å­˜çš„æ¢ç¢¼åˆ—è¡¨ -->
                    <div id="localBarcodeList" class="local-barcode-list">
                        <h3>å·²å„²å­˜çš„æ¢ç¢¼ (<span id="localBarcodeCount">0</span>)</h3>
                        <div class="barcode-items">
                            <!-- å‹•æ…‹æ’å…¥æš«å­˜çš„æ¢ç¢¼é …ç›® -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸Šå‚³ç¢ºèªå°è©±æ¡† -->
            <div id="uploadModal" class="modal">
                <div class="modal-content">
                    <h2>é€ä¿¡</h2>
                    <p>æ˜¯å¦é€ä¿¡è‡³è³‡æ–™åº«ï¼Ÿ</p>
                    <div class="upload-preview">
                        <div class="local-data-summary">
                            å…±æœ‰ <span id="uploadCount">0</span> ç­†è³‡æ–™å¾…é€ä¿¡
                        </div>
                    </div>
                    <div id="loadingText" class="loading-text">è³‡æ–™è™•ç†ä¸­</div>
                    <div class="form-actions">
                        <button class="btn-upload">é€ä¿¡</button>
                        <button class="btn-cancel">çµ‚äº†</button>
                    </div>
                </div>
            </div>

            <!-- è©³æƒ…é é¢ -->
            <div id="detailPage" class="page hidden">
                <div class="detail-header">
                    <button class="back-button" onclick="showPage('mainPage')">è¿”å›</button>
                    <h2>å•†å“è©³æƒ…</h2>
                </div>
                <div class="detail-content">
                    <div class="detail-image-section">
                        <img id="detailImage" src="" alt="å•†å“åœ–ç‰‡" class="detail-image">
                        <div id="imageUploadSection" class="image-upload-section hidden">
                            <input type="text" id="imageNameInput" placeholder="è¼¸å…¥åœ–ç‰‡åç¨±" class="image-name-input">
                            <button id="uploadImageBtn" class="upload-image-btn">ä¸Šå‚³åœ–ç‰‡</button>
                        </div>
                    </div>
                    <div class="detail-info">
                        <div class="detail-item">
                            <label>æ¢ç¢¼ï¼š</label>
                            <span id="detailBarcode"></span>
                        </div>
                        <div class="detail-item">
                            <label>å•†å“åç¨±ï¼š</label>
                            <span id="detailName"></span>
                        </div>
                        <div class="detail-item">
                            <label>åƒ¹æ ¼ï¼š</label>
                            <span id="detailPrice"></span>
                        </div>
                        <div class="detail-item">
                            <label>åº«å­˜ï¼š</label>
                            <span id="detailStock"></span>
                        </div>
                        <div class="detail-item">
                            <label>å‚™è¨»ï¼š</label>
                            <span id="detailNote"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ èª¿è©¦æŒ‰éˆ•ï¼ˆæ­£å¼ç’°å¢ƒå¯ä»¥ç§»é™¤ï¼‰ -->
    <script>
    // æ·»åŠ èª¿è©¦åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        // å‰µå»ºèª¿è©¦æŒ‰éˆ•
        const debugBtn = document.createElement('button');
        debugBtn.textContent = 'DEBUG';
        debugBtn.style.cssText = 'position: fixed; bottom: 10px; left: 10px; z-index: 10001; background: red; color: white; border: none; padding: 5px; border-radius: 5px; font-size: 10px; opacity: 0.5;';
        document.body.appendChild(debugBtn);
        
        // èª¿è©¦é¢æ¿
        const debugPanel = document.getElementById('debug-panel');
        const debugLog = document.getElementById('debug-log');
        
        // é»æ“ŠæŒ‰éˆ•é¡¯ç¤º/éš±è—èª¿è©¦é¢æ¿
        debugBtn.addEventListener('click', function() {
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        });
        
        // æ•ç² console.log å’Œ errors
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = function() {
            const args = Array.from(arguments);
            originalConsoleLog.apply(console, args);
            
            const logItem = document.createElement('div');
            logItem.textContent = '[LOG] ' + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            if (debugLog) debugLog.appendChild(logItem);
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            while (debugLog && debugLog.childNodes.length > 100) {
                debugLog.removeChild(debugLog.firstChild);
            }
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            if (debugPanel) debugPanel.scrollTop = debugPanel.scrollHeight;
        };
        
        console.error = function() {
            const args = Array.from(arguments);
            originalConsoleError.apply(console, args);
            
            const logItem = document.createElement('div');
            logItem.textContent = '[ERROR] ' + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            logItem.style.color = 'red';
            if (debugLog) debugLog.appendChild(logItem);
            
            if (debugPanel) debugPanel.scrollTop = debugPanel.scrollHeight;
        };
        
        console.warn = function() {
            const args = Array.from(arguments);
            originalConsoleWarn.apply(console, args);
            
            const logItem = document.createElement('div');
            logItem.textContent = '[WARN] ' + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            logItem.style.color = 'orange';
            if (debugLog) debugLog.appendChild(logItem);
            
            if (debugPanel) debugPanel.scrollTop = debugPanel.scrollHeight;
        };
        
        // æ•ç²å…¨å±€éŒ¯èª¤
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.message, 'at', event.filename, 'line', event.lineno);
        });
        
        // æ•ç²æœªè™•ç†çš„ Promise éŒ¯èª¤
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });
        
        // æª¢æ¸¬ PWA ç‹€æ…‹
        const pwaStatus = document.getElementById('pwa-status');
        const isPwa = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true || 
                    window.location.search.includes('source=pwa');
                    
        if (isPwa && pwaStatus) {
            pwaStatus.style.display = 'block';
        }
        
        // é¡¯ç¤ºè¨­å‚™ä¿¡æ¯
        console.log('User Agent:', navigator.userAgent);
        console.log('PWA Mode:', isPwa);
        console.log('GitHub Pages:', window.location.hostname.includes('github.io'));
    });
    </script>

    <!-- å…ˆè¼‰å…¥é…ç½® -->
    <script src="js/config.js"></script>
    <!-- å†è¼‰å…¥å…¶ä»– JS -->
    <script src="js/custom-confirm.js"></script>
    <script src="js/local-manager.js"></script>
    <script src="js/barcodeService.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <!-- PWA å¢å¼· -->
    <script src="js/auth-pwa.js"></script>
    <script src="js/pwa-handler.js"></script>
    <!-- ä¿®å¾©è…³æœ¬ -->
    <script src="js/fix-upload.js"></script>

    <!-- æ¢ç¢¼é …ç›®ç¯„æœ¬ -->
    <template id="barcodeItemTemplate">
        <div class="barcode-item">
            <h3 class="product-name"></h3>
            <div class="store-badge"></div>
            <div class="barcode-info">
                <div class="barcode-info-row">
                    <span class="barcode-info-label">æ¢ç¢¼ï¼š</span>
                    <span class="barcode-info-value barcode-number"></span>
                </div>
                <div class="barcode-info-row">
                    <span class="barcode-info-label">åƒ¹æ ¼ï¼š</span>
                    <span class="barcode-info-value price"></span>
                </div>
            </div>
            <div class="description-text"></div>
        </div>
    </template>
</body>
</html> 